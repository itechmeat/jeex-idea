# JEEX Idea PostgreSQL 18 Configuration
# Optimized for development environment with production-ready settings

# Connection Settings
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# Memory Settings (optimized for container with 1GB limit)
shared_buffers = 256MB                  # 25% of available memory
effective_cache_size = 1GB              # Total available memory
work_mem = 16MB                         # Per connection sort memory
maintenance_work_mem = 128MB            # For maintenance operations
autovacuum_work_mem = -1                # Use maintenance_work_mem

# Checkpoint Settings
checkpoint_completion_target = 0.9      # Smoother checkpointing
wal_buffers = 16MB                      # WAL buffer size
checkpoint_timeout = 15min              # Between checkpoints
max_wal_size = 1GB                      # WAL size before checkpoint
min_wal_size = 128MB                    # Minimum WAL size

# WAL Settings for Backup/Recovery
wal_level = replica                     # Enable WAL archiving
archive_mode = on                       # Enable WAL archiving
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
wal_compression = on                    # Compress WAL files
wal_log_hints = on                      # Additional logging for tools

# Query Performance Settings
random_page_cost = 1.1                  # Optimized for SSD
effective_io_concurrency = 200          # Concurrent I/O capacity
seq_page_cost = 1.0                     # Sequential scan cost

# Logging Settings
log_destination = 'stderr'              # Log to stderr
logging_collector = on                  # Enable logging collector
log_directory = 'log'                   # Log directory
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                   # Rotate daily
log_rotation_size = 100MB               # Rotate at 100MB
log_min_messages = warning              # Minimum log level
log_min_error_statement = error         # Log error statements
log_min_duration_statement = 1000       # Log slow queries (>1s)
log_checkpoints = on                    # Log checkpoints
log_connections = on                    # Log connections
log_disconnections = on                 # Log disconnections
log_lock_waits = on                     # Log lock waits
log_temp_files = 10MB                   # Log temp file usage

# Auto-Vacuum Settings
autovacuum = on                         # Enable autovacuum
autovacuum_max_workers = 3              # Number of workers
autovacuum_naptime = 30s                # Check interval
autovacuum_vacuum_threshold = 50        # Rows before vacuum
autovacuum_vacuum_scale_factor = 0.1    # Scale factor for vacuum
autovacuum_analyze_threshold = 50       # Rows before analyze
autovacuum_analyze_scale_factor = 0.05  # Scale factor for analyze
autovacuum_vacuum_cost_delay = 5ms      # Vacuum throttling

# Statement Statistics
track_activities = on                   # Track activity
track_counts = on                       # Track usage counts
track_io_timing = on                    # Track I/O timing
track_activity_query_size = 2048        # Query size limit
track_functions = all                   # Track function calls

# Performance Monitoring Extensions
shared_preload_libraries = 'pg_stat_statements,auto_explain'
pg_stat_statements.track = all           # Track all statements
pg_stat_statements.max = 10000           # Maximum statements
pg_stat_statements.track_utility = off   # Don't track utility commands

# Auto-Explain for Slow Queries
auto_explain.log_min_duration = 1000     # Explain slow queries
auto_explain.log_analyze = on            # Include analyze
auto_explain.log_verbose = on            # Include verbose output
auto_explain.log_format = json           # JSON format for parsing
auto_explain.log_timing = on             # Include timing
auto_explain.log_triggers = on           # Include triggers
auto_explain.log_nested_statements = on  # Include nested statements

# Client Connection Defaults
client_min_messages = notice             # Client message level
search_path = '"$user", public'          # Schema search order
default_tablespace = ''                  # Default tablespace
temp_tablespaces = ''                    # Temporary tablespaces
default_toast_compression = 'pglz'       # TOAST compression

# Locale and Formatting
datestyle = 'iso, mdy'                   # Date format
timezone = 'UTC'                         # UTC timezone
lc_messages = 'en_US.utf8'               # Message locale
lc_monetary = 'en_US.utf8'               # Monetary locale
lc_numeric = 'en_US.utf8'                # Numeric locale
lc_time = 'en_US.utf8'                   # Time locale
default_text_search_config = 'pg_catalog.english'

# Security Settings
# ssl = on                               # Enable SSL/TLS (disabled by default)
# ssl_cert_file = '/var/lib/postgresql/server.crt'
# ssl_key_file = '/var/lib/postgresql/server.key'
# ssl_ca_file = '/var/lib/postgresql/ca.crt'
password_encryption = 'scram-sha-256'    # Strong password encryption

# JIT Compilation (PostgreSQL 12+)
jit = on                                 # Enable JIT
jit_above_cost = 100000                  # JIT threshold
jit_inline_above_cost = 500000           # Inline threshold
jit_optimize_above_cost = 500000         # Optimize threshold

# Parallelism Settings
max_worker_processes = 8                 # Maximum worker processes
max_parallel_workers_per_gather = 4      # Parallel workers per query
max_parallel_maintenance_workers = 4     # Workers for maintenance
max_parallel_workers = 8                 # Total parallel workers

# Statement Timeout and Resource Limits
statement_timeout = 300000               # 5 minutes per statement
lock_timeout = 60000                     # 1 minute lock timeout
idle_in_transaction_session_timeout = 300000  # 5 minutes idle timeout
vacuum_cost_limit = 200                  # Vacuum cost limit
vacuum_cost_delay = 0                    # Vacuum throttling off by default