# Техническая спецификация JEEX Idea

Назначение: зафиксировать используемые технологии и принципы их применения. Все архитектурные диаграммы, потоки, ER‑схемы, примеры кода и SQL‑детали перенесены в `architecture.md`.

## 1) Технологический стек

Выбор технологий обусловлен необходимостью создания надежной, масштабируемой системы с поддержкой мультиагентной архитектуры и векторного поиска. Все компоненты интегрируются через четко определенные API и обеспечивают горизонтальное масштабирование.

### 1.1 Бэкенд

Серверная часть построена на современном Python-стеке с акцентом на производительность, типобезопасность и мульти-агентную архитектуру:

- **API Framework:** FastAPI 0.116.2+ (Python) — высокопроизводительный веб-фреймворк с автоматической генерацией OpenAPI документации, встроенной валидацией и Swagger UI для интерактивного тестирования API
- **Agent Framework:** CrewAI 0.186.1+ для мультиагентной архитектуры — оркестрация команд специализированных агентов с поддержкой различных LLM
- **Agent Development Kit (ADK):** Поддержка Google ADK для будущего выделения агентов в удаленные сервисы — совместимость протоколов с [Google ADK](https://google.github.io/adk-docs/) для A2A (Agent-to-Agent) коммуникации
- **I/O Structuring:** Pydantic AI 1.0.8+ для контрактов агентов — строгая типизация и валидация данных на всех уровнях, включая промпты и ответы агентов
- **Language Detection (LLM-based):** Определение языка проекта из первого сообщения пользователя **исключительно через LLM** с сохранением на уровне проекта. **КРИТИЧЕСКОЕ ТРЕБОВАНИЕ:** использование скриптов/библиотек для автоматического определения языка (langdetect, langid, fastText и др.) строго **ЗАПРЕЩЕНО**
- **Response Parser:** Компонент для парсинга ответов пользователя в свободном и структурированном форматах (1.b, 2.c)
- **Primary Database:** PostgreSQL 18 — надежное хранение документов, версий и метаданных (включая язык проекта) с ACID гарантиями, UUID v7 и AIO производительностью
- **Database Migrations:** Alembic для версионирования схемы и безопасных миграций базы данных с автоматической поддержкой отката
- **Vector Database:** Qdrant 1.15.4+ для эмбеддингов и контекста — специализированная база данных для семантического поиска с фильтрацией по проекту и языку
- **Cache/Queue:** Redis 8.2+ для буферизации и квот — быстрое кэширование и управление очередями задач
- **Authentication:** OAuth2 (только Twitter на первом этапе) — поддержка других провайдеров не предусмотрена в MVP
- **Streaming:** Server-Sent Events (SSE) — обновления в реальном времени прогресса генерации документов и взаимодействия агентов
- **Reliability:** Tenacity для логики повторных попыток и автоматических выключателей при взаимодействии с внешними LLM API
- **Observability:** OpenTelemetry для распределенного трейсинга с автоматической инструментацией FastAPI
- **Content Quality:** textstat для оценки читабельности документов и language-check для валидации грамматики (с поддержкой множества языков)
- **Document Processing:** python-markdown с расширениями (Mermaid, таблицы, TOC) для расширенного рендеринга Markdown

### 1.2 Фронтенд

Клиентская часть создается как современное SPA приложение с акцентом на UX и производительность:

- **Framework:** React.js + Vite — быстрая разработка и горячая перезагрузка, оптимизированная сборка для продакшена
- **Language:** TypeScript — статическая типизация для безопасности кода и поддерживаемости
- **UI Components:** RadixUI — доступные, композитные компоненты с полной кастомизацией стилей
- **Styling:** CSS Modules с CSS Nesting — изолированные стили с поддержкой переменных и вложенных селекторов
- **Development Port:** 5200 — настроенный через конфигурацию Vite для локальной разработки
- **Deployment:** Запускается локально вне Docker окружения для удобства разработки и горячей перезагрузки

### 1.3 Инфраструктура

Технологии:

- **Containerization:** Docker
- **Reverse Proxy:** Nginx
- **Observability:** OpenTelemetry stack

Схемы портов и конфигурации см. в `architecture.md`.

### 1.4 Сервис эмбеддингов

Применяемые технологии и правила:

- **Text Processing:** нормализация, разбиение, дедупликация
- **Embedding Model:** единая модель (MVP)
- **Vector DB:** Qdrant 1.15.4+
- **Фильтрация:** строго по `project_id`

### 1.5 Минимальные версии компонентов

Для обеспечения совместимости и доступа к новейшим функциям требуются следующие минимальные версии:

| Компонент       | Минимальная версия | Обоснование                                                                          |
| --------------- | ------------------ | ------------------------------------------------------------------------------------ |
| FastAPI         | 0.116.2+           | Улучшенная инъекция зависимостей, лучшая поддержка async                             |
| CrewAI          | 0.186.1+           | Улучшенная оркестрация мультиагентов, управление памятью                             |
| Pydantic AI     | 1.0.8+             | Стабильный API, продвинутые функции валидации                                        |
| PostgreSQL      | 18                 | Генерация UUID v7, производительность AIO, виртуальные колонки, SCRAM аутентификация |
| Qdrant          | 1.15.4+            | Оптимизация мультитенантности, улучшения фильтрации payload                          |
| Redis           | 8.2+               | Улучшенная эффективность памяти, расширенный pub/sub                                 |
| Tenacity        | 9.0+               | Надежные механизмы повторов, шаблоны автоматических выключателей                     |
| OpenTelemetry   | 1.27+              | Автоинструментация FastAPI, распределенный трейсинг                                  |
| textstat        | 0.7.0+             | Оценка читабельности документов (Flesch-Kincaid и др.)                               |
| python-markdown | 3.7+               | Расширенная обработка Markdown с поддержкой Mermaid и таблиц                         |
| Alembic         | 1.13+              | Миграции схемы базы данных с автоматической поддержкой отката                        |

> Системные диаграммы и потоковые схемы представлены в `architecture.md`.

### 1.6 Мульти-агентная архитектура и ADK

**Архитектура:**

- **Product Manager Agent (координатор)** — управляет жизненным циклом документов, координирует работу команд экспертов
- **Команды специализированных агентов** на каждом этапе (Idea, Specs, Architecture, Planning)
- **Унифицированные протоколы взаимодействия** через Pydantic AI контракты
- **Поддержка Agent Development Kit (ADK)** от Google для будущей совместимости

**Google Agent Development Kit (ADK):**

ADK — это фреймворк от Google для создания и оркестрации агентов с поддержкой A2A (Agent-to-Agent) коммуникации. Ключевые возможности:

- **Унифицированные протоколы** для взаимодействия агентов (локальных и удаленных)
- **Типизированные контракты** через Pydantic для входов/выходов агентов
- **Observability из коробки** с трейсингом межагентных вызовов
- **Масштабируемость** через выделение агентов в отдельные сервисы

**Интеграция с JEEX Idea:**

- На старте все агенты работают локально в рамках единого бекенда
- Архитектура спроектирована с учетом ADK спецификаций для будущего выделения агентов
- Каждый агент реализован с явными I/O контрактами через Pydantic AI
- При необходимости масштабирования агенты могут быть вынесены на отдельные серверы без изменения протоколов взаимодействия
- Product Manager остается центральным координатором независимо от размещения агентов

**Дополнительная информация:**

- [Документация ADK](https://google.github.io/adk-docs/)
- [Примеры A2A паттернов](https://google.github.io/adk-docs/agent-to-agent/)
- [Спецификации протоколов](https://google.github.io/adk-docs/protocols/)

## 2) Хранилище векторных представлений (Qdrant)

Принципы применения:

- Единая коллекция с обязательной фильтрацией по `project_id` И `language`
- Индексация payload и строгие серверные фильтры (составной индекс)
- Оптимизации чтения и размещения данных проекта с учетом языковой изоляции
- Автоматическое определение языка проекта из первого сообщения пользователя
- Векторный поиск выполняется только в рамках эмбеддингов на языке проекта

Все конфигурации и примеры вынесены в `architecture.md`.

## 3) API (принципы)

- RESTful ресурсы, SSE для длительных операций и стриминга взаимодействия с агентами
- Изоляция по `project_id` и `language` на уровне middleware
- Определение языка проекта при первом сообщении **исключительно через LLM** (использование библиотек детектирования языка запрещено)
- Response Parser для обработки ответов в свободном и структурированном форматах (1.b, 2.c)
- OAuth2 (JWT) — только через Twitter на первом этапе; ограничение скорости (пользователь/проект/IP)

Полные списки эндпоинтов и диаграммы — в `architecture.md`.

## 4) Контракты агентов (принципы)

- **Явные I/O‑контракты** на Pydantic AI для всех агентов
- **Product Manager** как центральный координатор с доступом ко всем агентам
- **Команды специализированных агентов** на каждом этапе (Idea, Specs, Architecture, Planning)
- **Совместимость с ADK** для будущего выделения агентов в удаленные сервисы
- **Языковой контекст** передается каждому агенту; все генерируемые материалы на языке проекта
- **Структурированные вопросы** от агентов с нумерованными вариантами ответов (a, b, c, d, e)
- **Гибкий формат ответов** пользователя: свободный текст, выбор вариантов (1.b, 2.c) или комбинация
- **Двухэтапная генерация**:
  1. Эксперт формирует текст по своей части после получения ответов
  2. Эксперт выводит текст в чат для ознакомления пользователя
  3. Product Manager интегрирует текст эксперта (частично или полностью) в основной документ
- **Валидация результатов** перед сохранением
- **Чек‑листы качества** по типам документов
- **Циклическое взаимодействие** с возможностью прерывания пользователем

Конкретные модели и интерфейсы приведены при необходимости в `architecture.md`.

## 5) Данные и хранение (принципы)

- **PostgreSQL** — источник истины, версионирование артефактов с метаданными языка проекта
- **Qdrant** — семантический поиск в контексте проекта с двойной фильтрацией (project_id + language)
- **Redis** — кэш/очереди/квоты
- **Языковая изоляция** на уровне данных: каждый проект имеет зафиксированный язык, определённый при создании через LLM (не через скрипты)

ER‑диаграммы, SQL и индексация — в `architecture.md`.

## 6) Требования безопасности

Безопасность реализована по принципу "защиты в глубину" с несколькими уровнями защиты, начиная от сетевой безопасности до контроля на уровне приложения.

### 6.1 Аутентификация и авторизация

- **OAuth2 + JWT** (только Twitter на первом этапе) с механизмом обновления
- **RBAC** на уровне проекта: owner/editor/viewer
- **Rate limiting**: на пользователя, проект и IP (Redis)
- **Security middleware**: CORS, заголовки, валидация и санация ввода

### 6.2 Изоляция данных

- Обязательная фильтрация по `project_id` И `language` на всех уровнях (БД, векторная БД, кэш)
- Агенты имеют доступ только к данным текущего проекта на языке проекта
- Фильтры Qdrant формируются на сервере с составным условием и не могут быть обойдены
- Язык проекта фиксируется при создании и не может быть изменён (иммутабельность языка)
- Все генерируемые документы и взаимодействия строго на языке проекта
- (Опционально) RLS в PostgreSQL с учётом project_id

### 6.3 Конфиденциальность и соответствие

- TLS 1.3, шифрование чувствительных данных, ротация секретов
- Аудит-логи с correlation ID и хранением в пределах политики

## 7) Разработка и развертывание

- Бэкенд в Docker, фронтенд локально (pnpm)
- Фронтенд: строго использовать pnpm (npm и yarn запрещены)
- Использовать Makefile‑таргеты для рутины
- Секреты — через переменные окружения

### 7.1 Тестирование

- Pytest (backend), pnpm тесты (frontend), Playwright (E2E)

### 7.2 CI/CD

- Lint → Test → Security → Build → Deploy

---

Ссылки:

- [Qdrant Multi-tenancy Best Practices](https://medium.com/qdrant/the-tao-of-qdrant-multi-tenancy-162c71f830fb)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [CrewAI Framework](https://github.com/joaomdmoura/crewAI)
- [Pydantic AI](https://github.com/pydantic/pydantic-ai)
